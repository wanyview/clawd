<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kai çŸ¥è¯†èƒ¶å›Šç®¡ç†åå°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; }
        .user-info { display: flex; gap: 20px; align-items: center; }
        
        .container { display: flex; min-height: calc(100vh - 70px); }
        .sidebar { width: 200px; background: white; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .sidebar-item { padding: 15px 20px; cursor: pointer; border-left: 3px solid transparent; transition: all 0.3s; }
        .sidebar-item:hover, .sidebar-item.active { background: #f0f0ff; border-left-color: #667eea; color: #667eea; }
        
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; }
        .stat-card .value { font-size: 28px; font-weight: bold; color: #333; }
        
        .card { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { font-size: 18px; }
        .card-body { padding: 20px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; color: #666; font-weight: 500; }
        
        .badge { padding: 3px 8px; border-radius: 3px; font-size: 12px; }
        .badge-success { background: #e8f5e9; color: #4CAF50; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 10px; width: 500px; max-width: 90%; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 20px; border-top: 1px solid #eee; text-align: right; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #666; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        
        .log-console { background: #1e1e1e; color: #0f0; font-family: monospace; padding: 15px; border-radius: 5px; height: 200px; overflow-y: auto; font-size: 12px; }
        .log-entry { margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§  Kai çŸ¥è¯†èƒ¶å›Šç®¡ç†åå°</h1>
        <div class="user-info">
            <span id="server-status">ğŸ”´ æ£€æµ‹ä¸­...</span>
            <span id="current-time"></span>
        </div>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-item active" onclick="showPage('dashboard')">ğŸ“Š æ•°æ®ä»ªè¡¨æ¿</div>
            <div class="sidebar-item" onclick="showPage('capsules')">ğŸ’ èƒ¶å›Šç®¡ç†</div>
            <div class="sidebar-item" onclick="showPage('users')">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</div>
            <div class="sidebar-item" onclick="showPage('trade')">ğŸ’° äº¤æ˜“ç®¡ç†</div>
            <div class="sidebar-item" onclick="showPage('wallet')">ğŸ’µ é’±åŒ…ç®¡ç†</div>
            <div class="sidebar-item" onclick="showPage('api')">ğŸ”Œ APIæ–‡æ¡£</div>
            <div class="sidebar-item" onclick="showPage('logs')">ğŸ“‹ è¿è¡Œæ—¥å¿—</div>
        </div>
        
        <div class="main">
            <div id="page-dashboard" class="page">
                <div class="stats-grid">
                    <div class="stat-card"><h3>æ€»èƒ¶å›Šæ•°</h3><div class="value" id="stat-capsules">0</div></div>
                    <div class="stat-card"><h3>æ€»ç”¨æˆ·æ•°</h3><div class="value" id="stat-users">0</div></div>
                    <div class="stat-card"><h3>æ€»äº¤æ˜“é¢</h3><div class="value" id="stat-volume">Â¥0</div></div>
                    <div class="stat-card"><h3>å¹³å‡è¯„åˆ†</h3><div class="value" id="stat-score">0.0</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h2>ğŸ“ˆ èƒ¶å›Šé¢†åŸŸåˆ†å¸ƒ</h2></div>
                    <div class="card-body" id="domain-chart"><p>åŠ è½½ä¸­...</p></div>
                </div>
            </div>
            
            <div id="page-capsules" class="page" style="display: none;">
                <div class="card">
                    <div class="card-header"><h2>ğŸ’ èƒ¶å›Šåˆ—è¡¨</h2><button class="btn btn-primary" onclick="showModal('create-capsule')">+ åˆ›å»ºèƒ¶å›Š</button></div>
                    <div class="card-body">
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="capsule-search" placeholder="æœç´¢..." style="flex:1; padding:10px; border:1px solid #ddd;">
                            <select id="capsule-domain" style="padding:10px;"><option value="">å…¨éƒ¨åˆ†ç±»</option><option value="technology">ç§‘æŠ€</option><option value="physics">ç‰©ç†</option></select>
                            <button class="btn btn-primary" onclick="loadCapsules()">æœç´¢</button>
                        </div>
                        <table><thead><tr><th>ID</th><th>æ ‡é¢˜</th><th>é¢†åŸŸ</th><th>è¯„åˆ†</th><th>ä½œè€…</th><th>æ“ä½œ</th></tr></thead><tbody id="capsule-table"><tr><td colspan="6">åŠ è½½ä¸­...</td></tr></tbody></table>
                    </div>
                </div>
            </div>
            
            <div id="page-users" class="page" style="display: none;">
                <div class="card">
                    <div class="card-header"><h2>ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨</h2><button class="btn btn-primary" onclick="showModal('create-user')">+ æ·»åŠ ç”¨æˆ·</button></div>
                    <div class="card-body"><table><thead><tr><th>ç”¨æˆ·å</th><th>é‚®ç®±</th><th>è§’è‰²</th><th>æ“ä½œ</th></tr></thead><tbody id="user-table"><tr><td colspan="4">åŠ è½½ä¸­...</td></tr></tbody></table></div>
                </div>
            </div>
            
            <div id="page-trade" class="page" style="display: none;">
                <div class="card">
                    <div class="card-header"><h2>ğŸ’° äº¤æ˜“è®°å½•</h2></div>
                    <div class="card-body"><table><thead><tr><th>äº¤æ˜“ID</th><th>ç±»å‹</th><th>å‘é€æ–¹</th><th>æ¥æ”¶æ–¹</th><th>é‡‘é¢</th><th>æ—¶é—´</th></tr></thead><tbody id="trade-table"><tr><td colspan="6">åŠ è½½ä¸­...</td></tr></tbody></table></div>
                </div>
            </div>
            
            <div id="page-wallet" class="page" style="display: none;">
                <div class="card">
                    <div class="card-header"><h2>ğŸ’µ é’±åŒ…ç®¡ç†</h2></div>
                    <div class="card-body"><table><thead><tr><th>ç”¨æˆ·</th><th>ä½™é¢</th><th>åˆ›å»ºæ—¶é—´</th></tr></thead><tbody id="wallet-table"><tr><td colspan="3">åŠ è½½ä¸­...</td></tr></tbody></table></div>
                </div>
            </div>
            
            <div id="page-api" class="page" style="display: none;">
                <div class="card">
                    <div class="card-header"><h2>ğŸ”Œ API æ–‡æ¡£</h2></div>
                    <div class="card-body">
                        <div class="api-section"><h4>åˆ›å»ºèƒ¶å›Š</h4><div class="api-endpoint">POST /api/capsules</div><pre>{"title":"string","content":"string","domain":"technology"}</pre></div>
                        <div class="api-section"><h4>è½¬è´¦</h4><div class="api-endpoint">POST /api/transfer</div><pre>{"from_user":"alice","to_user":"bob","amount":100}</pre></div>
                        <div class="api-section"><h4>æŸ¥è¯¢èƒ¶å›Š</h4><div class="api-endpoint">GET /api/capsules?limit=20</div></div>
                    </div>
                </div>
            </div>
            
            <div id="page-logs" class="page" style="display: none;">
                <div class="card"><div class="card-header"><h2>ğŸ“‹ è¿è¡Œæ—¥å¿—</h2><button class="btn btn-primary" onclick="addLog('æ‰‹åŠ¨åˆ·æ–°')">ğŸ”„ åˆ·æ–°</button></div>
                    <div class="card-body"><div class="log-console" id="log-console"><div class="log-entry">[å¯åŠ¨] ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ</div></div></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¼¹çª— -->
    <div class="modal" id="modal-create-capsule">
        <div class="modal-content">
            <div class="modal-header"><h3>åˆ›å»ºèƒ¶å›Š</h3><span style="cursor:pointer" onclick="closeModal('create-capsule')">âœ•</span></div>
            <div class="modal-body">
                <div class="form-group"><label>æ ‡é¢˜</label><input type="text" id="capsule-title" placeholder="è¾“å…¥æ ‡é¢˜"></div>
                <div class="form-group"><label>å†…å®¹</label><textarea id="capsule-content" rows="4" placeholder="è¾“å…¥å†…å®¹"></textarea></div>
                <div class="form-group"><label>é¢†åŸŸ</label><select id="capsule-domain-input"><option value="general">é€šç”¨</option><option value="technology">ç§‘æŠ€</option><option value="physics">ç‰©ç†</option></select></div>
            </div>
            <div class="modal-footer"><button class="btn" onclick="closeModal('create-capsule')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="createCapsule()">åˆ›å»º</button></div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8011';
        let capsules = [];
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            document.getElementById('page-' + pageId).style.display = 'block';
            event.target.classList.add('active');
            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'capsules') loadCapsules();
            if (pageId === 'users') loadUsers();
            if (pageId === 'trade') loadTrades();
            if (pageId === 'wallet') loadWallets();
        }
        
        async function loadDashboard() {
            try {
                const [caps, stats, market] = await Promise.all([
                    fetch(API_BASE + '/api/capsules?limit=100'),
                    fetch(API_BASE + '/api/capsules/stats'),
                    fetch(API_BASE + '/api/market')
                ]);
                const capsData = await caps.json();
                const statsData = await stats.json();
                const marketData = await market.json();
                
                document.getElementById('stat-capsules').textContent = statsData.total_capsules || 0;
                document.getElementById('stat-score').textContent = statsData.avg_datm_score || 0;
                document.getElementById('stat-users').textContent = marketData.total_wallets || 0;
                document.getElementById('stat-volume').textContent = 'Â¥' + (marketData.total_sold * 50 || 0);
                
                let domains = '<div style="display:flex;flex-wrap:wrap;gap:10px;">';
                for (const [d, c] of Object.entries(statsData.domains || {})) {
                    domains += `<span class="badge badge-success">${d}: ${c}</span>`;
                }
                domains += '</div>';
                document.getElementById('domain-chart').innerHTML = domains;
                addLog('ä»ªè¡¨æ¿åŠ è½½å®Œæˆ');
            } catch (e) { addLog('ä»ªè¡¨æ¿åŠ è½½å¤±è´¥: ' + e.message, 'error'); }
        }
        
        async function loadCapsules() {
            try {
                const res = await fetch(API_BASE + '/api/capsules?limit=100');
                capsules = await res.json();
                renderCapsules();
                addLog('èƒ¶å›Šåˆ—è¡¨åŠ è½½å®Œæˆ (' + capsules.length + ')');
            } catch (e) { addLog('èƒ¶å›ŠåŠ è½½å¤±è´¥: ' + e.message, 'error'); }
        }
        
        function renderCapsules() {
            const html = capsules.map(c => `<tr><td style="font-size:11px;color:#666;">${c.id.substring(0,16)}...</td><td>${c.title}</td><td><span class="badge badge-success">${c.domain}</span></td><td>${c.datm_score}</td><td>${c.author}</td><td><button class="btn btn-danger" style="padding:5px 10px;font-size:12px;" onclick="deleteCapsule('${c.id}')">åˆ é™¤</button></td></tr>`).join('');
            document.getElementById('capsule-table').innerHTML = html || '<tr><td colspan="6">æš‚æ— æ•°æ®</td></tr>';
        }
        
        async function createCapsule() {
            const data = { title: document.getElementById('capsule-title').value, content: document.getElementById('capsule-content').value, domain: document.getElementById('capsule-domain-input').value, author: 'Admin' };
            try {
                await fetch(API_BASE + '/api/capsules', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
                addLog('èƒ¶å›Šåˆ›å»ºæˆåŠŸ: ' + data.title);
               -capsule');
                loadCapsules();
 closeModal('create                loadDashboard();
            } catch (e) { addLog('åˆ›å»ºå¤±è´¥: ' + e.message, 'error'); }
        }
        
        async function deleteCapsule(id) {
            if (!confirm('ç¡®å®šåˆ é™¤?')) return;
            try { await fetch(API_BASE + '/api/capsules/' + id, { method: 'DELETE' }); addLog('èƒ¶å›Šåˆ é™¤æˆåŠŸ'); loadCapsules(); loadDashboard(); }
            catch (e) { addLog('åˆ é™¤å¤±è´¥: ' + e.message, 'error'); }
        }
        
        function loadUsers() {
            document.getElementById('user-table').innerHTML = '<tr><td>test_huangzhong</td><td>huangzhong@test.com</td><td><span class="badge badge-success">user</span></td><td><button class="btn btn-danger" style="padding:5px 10px;font-size:12px;">åˆ é™¤</button></td></tr><tr><td>user_alice</td><td>alice@test.com</td><td><span class="badge badge-success">user</span></td><td><button class="btn btn-danger" style="padding:5px 10px;font-size:12px;">åˆ é™¤</button></td></tr>';
            addLog('ç”¨æˆ·åˆ—è¡¨åŠ è½½å®Œæˆ');
        }
        
        async function loadTrades() {
            try {
                const res = await fetch(API_BASE + '/api/transactions/user_alice?limit=50');
                const data = await res.json();
                const html = (data.transactions || []).map(t => `<tr><td style="font-size:11px;">${t.id.substring(0,12)}...</td><td><span class="badge badge-success">${t.tx_type}</span></td><td>${t.from_user}</td><td>${t.to_user}</td><td>Â¥${t.amount}</td><td style="font-size:12px;">${t.created_at.substring(0,16)}</td></tr>`).join('');
                document.getElementById('trade-table').innerHTML = html || '<tr><td colspan="6">æš‚æ— äº¤æ˜“è®°å½•</td></tr>';
                addLog('äº¤æ˜“è®°å½•åŠ è½½å®Œæˆ');
            } catch (e) { addLog('äº¤æ˜“è®°å½•åŠ è½½å¤±è´¥', 'error'); }
        }
        
        async function loadWallets() {
            try {
                const [alice, bob] = await Promise.all([fetch(API_BASE + '/api/wallets/user_alice'), fetch(API_BASE + '/api/wallets/user_bob')]);
                const a = await alice.json();
                const b = await bob.json();
                const html = `<tr><td>${a.user_id}</td><td style="color:#4CAF50;font-weight:bold;">Â¥${a.balance}</td><td>${a.created_at.substring(0,10)}</td></tr><tr><td>${b.user_id}</td><td style="color:#4CAF50;font-weight:bold;">Â¥${b.balance}</td><td>${b.created_at.substring(0,10)}</td></tr>`;
                document.getElementById('wallet-table').innerHTML = html;
                addLog('é’±åŒ…åˆ—è¡¨åŠ è½½å®Œæˆ');
            } catch (e) { addLog('é’±åŒ…åŠ è½½å¤±è´¥', 'error'); }
        }
        
        function showModal(name) { document.getElementById('modal-' + name).classList.add('show'); }
        function closeModal(name) { document.getElementById('modal-' + name).classList.remove('show'); }
        
        function addLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span style="color:#888">[${time}]</span> <span style="color:${type==='error'?'#f44336':'#4CAF50'}">${msg}</span>`;
            document.getElementById('log-console').appendChild(entry);
            document.getElementById('log-console').scrollTop = document.getElementById('log-console').scrollHeight;
        }
        
        // çŠ¶æ€æ£€æµ‹
        setInterval(async () => {
            try {
                await fetch(API_BASE + '/');
                document.getElementById('server-status').textContent = 'ğŸŸ¢ æœåŠ¡æ­£å¸¸';
            } catch { document.getElementById('server-status').textContent = 'ğŸ”´ æœåŠ¡å¼‚å¸¸'; }
        }, 5000);
        
        // æ—¶é—´æ˜¾ç¤º
        setInterval(() => { document.getElementById('current-time').textContent = new Date().toLocaleString('zh-CN'); }, 1000);
        
        // åˆå§‹åŒ–
        loadDashboard();
        addLog('ç®¡ç†åå°å¯åŠ¨å®Œæˆ');
    </script>
</body>
</html>